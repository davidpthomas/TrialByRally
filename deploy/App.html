<!DOCTYPE html>
<html>
<head>
    <title>TrialByRally</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",data:{lineOfBusinessName:null,pilotProjectName:null,selectedParentProject:null},projectModel:null,projectTree:{name:"RallyTrial",children:[{name:"Company",children:[{name:"Line of Business",children:[{name:"Pilot Team",children:[{name:"Company Team"},{name:"Rally Team"}]}]}]}]},launch:function(){var me=this,navigate=function(panel,direction){console.log("data",me.data);var layout=panel.getLayout();layout[direction]();var backButton=Ext.getCmp("move-prev"),nextButton=Ext.getCmp("move-next");backButton.setDisabled(!layout.getPrev()),nextButton.setDisabled(!layout.getNext()),layout.getPrev()?nextButton.setText("Next"):nextButton.setText("Start"),"card-3"===layout.getActiveItem().getItemId()&&backButton.show(),"card-3"===layout.getActiveItem().getItemId()&&nextButton.setDisabled(!0),"card-4"===layout.getActiveItem().getItemId()&&nextButton.setDisabled(!0),"card-5"===layout.getActiveItem().getItemId()&&me.down("#card-5").update(me.data),"card-6"===layout.getActiveItem().getItemId()&&(backButton.hide(),nextButton.hide(),me._loadProjectModel())},card1=Ext.create("Ext.Component",{itemId:"card-1",html:"Welcome to Rally.<br/><br/>Let's start your Trial!"}),card2=Ext.create("Ext.Component",{itemId:"card-2",html:"Lets take this journey together by setting up a Trial Initiative and track our progress with some Stories!"}),card3=Ext.create("Ext.Container",{itemId:"card-3",items:[{html:"We will be creating a small project structure to store our initiatives, stories, etc.<br><br>  Pick an existing project to be the parent of our new structure.",margin:"0 0 15 0",border:0},{xtype:"rallyprojectpicker",fieldLabel:"Project",showMostRecentlyUsedProjects:!1,showProjectScopeUpAndDown:!1,workspace:this.getContext().getWorkspaceRef(),listeners:{change:function(picker){this.data.selectedParentProject=picker.getValue();var nextButton=Ext.getCmp("move-next");nextButton.setDisabled(!1)},scope:this}}]}),card4=Ext.create("Ext.Container",{itemId:"card-4",items:[{html:"We need a few names to customize the project structure.",border:0,margin:"0 0 10 0"},{xtype:"rallytextfield",itemId:"lineOfBusinessName",fieldLabel:"Line of Business",labelAlign:"right",labelWidth:100,labelCls:"field-label",listeners:{change:function(textfield,newValue,oldValue){this.data.lineOfBusinessName=newValue;var nextButton=Ext.getCmp("move-next"),pilotProjectName=this.down("#pilotProjectName").getValue();newValue.length>0&&pilotProjectName.length>0?nextButton.setDisabled(!1):nextButton.setDisabled(!0)},scope:this}},{html:"e.g. Consumer Products, Home Mortgages, etc",border:0,margin:"0 0 15 0",cls:"field-example"},{xtype:"rallytextfield",itemId:"pilotProjectName",fieldLabel:"Pilot Project",labelAlign:"right",labelWidth:100,labelCls:"field-label",listeners:{change:function(textfield,newValue,oldValue){this.data.pilotProjectName=newValue;var nextButton=Ext.getCmp("move-next"),lineOfBusinessName=this.down("#lineOfBusinessName").getValue();newValue.length>0&&lineOfBusinessName.length>0?nextButton.setDisabled(!1):nextButton.setDisabled(!0)},scope:this}},{html:"e.g. Scrum Team #1, Red Team, etc",border:0,cls:"field-example"}]}),card5=Ext.create("Ext.Component",{itemId:"card-5",data:null,tpl:new Ext.XTemplate("Line of Business: {lineOfBusinessName}","Pilot Project: {pilotProjectName}")}),card6=Ext.create("Ext.Component",{itemId:"card-6",html:"We are building your Trial!"}),card7=Ext.create("Ext.Component",{itemId:"card-6",html:"Congratulations!"}),wizard=Ext.create("Ext.panel.Panel",{title:"TrialByRally",width:400,height:300,layout:"card",bodyStyle:"padding: 15px",defaults:{border:!1},bbar:[{id:"move-prev",text:"Back",handler:function(btn){navigate(btn.up("panel"),"prev")},hidden:!0},"->",{id:"move-next",text:"Start",handler:function(btn){navigate(btn.up("panel"),"next")},disabled:!1}],items:[card1,card2,card3,card4,card5,card6]});this.add(wizard)},_createProjects:function(l){var workspaceRef="/workspace/699220";this._createProjectTree(workspaceRef,null,this.projectTree.name,this.projectTree.children)},_createProjectTree:function(workspaceRef,parentProjectRef,projectName,children){var me=this;console.log("creating project",workspaceRef,parentProjectRef,projectName,children);var record=Ext.create(this.projectModel,{Name:projectName,State:"Open",Parent:parentProjectRef,Workspace:workspaceRef});console.log("record",record),record.save({callback:function(result,operation){console.log("save result",result,operation),console.log(result.get("ObjectID"),result.get("Name"));var currParentProjectId=result.get("ObjectID");Ext.Array.each(children,function(child){console.log("child",child.name,child.children),me._createProjectTree(workspaceRef,currParentProjectId,child.name,child.children)})}})},_loadProjectModel:function(){Rally.data.ModelFactory.getModel({type:"Project",context:this.getContext().getDataContext(),scope:this,success:function(model){this.projectModel=model,this._createProjects()}},this)}});

            Rally.launchApp('CustomApp', {
                name:"TrialByRally",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

.field-label {
    font-weight: bold;
    color: red;
}

.field-example {
    font-style: italic;
    color: blue;
}
    </style>
</head>
<body></body>
</html>
